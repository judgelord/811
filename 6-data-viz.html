<!DOCTYPE html>
<html>
  <head>
    <title>Data Viz</title>
    <meta charset="utf-8">
    <meta name="author" content="Devin Judge-Lord" />
    <link rel="stylesheet" href="templates/xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Data Viz
### Devin Judge-Lord

---




![](Figs/plot-type.png)

---

#### Required reading
- [Data Visualization, Chapter 1 by Kieran Healy](http://socviz.co/lookatdata.html)
- [Charts change hearts and minds better than words do](https://www.washingtonpost.com/news/wonk/wp/2018/06/15/study-charts-change-hearts-and-minds-better-than-words-do/?utm_term=.89d85fd285ba)

#### Resources
- Andrew Heiss's [data viz class](https://datavizf18.classes.andrewheiss.com/schedule/)
- `ggplot` tips and tutorials from Dr. Jenny Brian's [stats class]((http://stat545.com/graph00_index.html)
- Claus E. Wilke on [Data Visualization](https://serialmentor.com/dataviz/index.html)
&lt;!-- [Basic principles of data viz](https://www.geckoboard.com/learn/data-literacy/data-visualization-tips/) --&gt;
- A plot that looks like ____? What is it called? -&gt; look 
[here](https://datavizcatalogue.com/) and
[here](https://datavizproject.com/)

#### Data viz in R
- [R for Data Science: Import, Tidy, Transform, Visualize, and Model Data](https://r4ds.had.co.nz/data-visualisation.html)
- [Principles &amp; Practice of Data Visualization] with ggplot2 by Dr. Alison Presmanes Hill](https://cslu.ohsu.edu/~bedricks/courses/cs631/)
- Examples from [data-to-viz.com](https://www.data-to-viz.com/) and in this [catalog (with R code)](http://shinyapps.stat.ubc.ca/r-graph-catalog/) from Joanna Zhao and Jenny Bryan, including [xkcd](http://shinyapps.stat.ubc.ca/r-graph-catalog/#0003_xkcd-and-direct-labelling)
- `ggplot2` [cheatsheet](https://www.rstudio.com/resources/cheatsheets/#ggplot2)
- Maps with `map_data()` from the `maps` package. Advanced maps: `r-spatial` [tutorial](https://r-spatial.github.io/sf/articles/sf5.html), `sf` [cheatsheat](https://github.com/rstudio/cheatsheets/blob/master/sf.pdf)  and `cartogrphy` [cheatsheet](https://github.com/riatelab/cartography)
- [A tutorial on minimalist, Tufte-style plots in R](http://motioninsocial.com/tufte/)
- [A 7 min video on the role of data viz in science](https://flowingdata.com/2013/05/24/the-art-of-data-visualization/)

---

# Why we plot 
## 1. To not lie
Avoid statistical fallacies.

## 2. To be clear
Our brains see patterns in distance, size, color, shape more easily than in numerals. Most analytic claims are about **variation** (**comparisons** and/or **relationships/trends**). Any numeric claim can be visualized.

"A picture is worth a thousand words."

--

*and far, far, far superior to ten numbers!

--

*"Always, always, always, plot the data"* - Dr. Jenny Brian

---

## [Anscombeâ€™s Quartet](https://www.geckoboard.com/learn/data-literacy/statistical-fallacies/danger-of-summary-metrics/)

![](Figs/stats-dangers-metrics.png)

---

## `tidy()` model output with `broom`
See [these slides](https://opr.princeton.edu/workshops/Downloads/2016Jan_BroomRobinson.pdf),
[this vignette](https://cran.r-project.org/web/packages/broom/vignettes/broom.html), and 
[this example](http://varianceexplained.org/r/broom-intro/).


```r
lm(height ~ mass, data = starwars)
```

```
## 
## Call:
## lm(formula = height ~ mass, data = starwars)
## 
## Coefficients:
## (Intercept)         mass  
##   171.28536      0.02807
```


```r
lm(height ~ mass, data = starwars) %&gt;%
  tidy(conf.int = TRUE)
```

```
## # A tibble: 2 x 7
##   term        estimate std.error statistic  p.value  conf.low conf.high
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1 (Intercept) 171.        5.34       32.1  3.73e-38  161.      182.    
## 2 mass          0.0281    0.0275      1.02 3.12e- 1   -0.0270    0.0832
```


```r
"The p-value for `r m1$term[2]` is `r m1$p.value[2]`."
```


---

## `tidy()` model output is easy to plot



```r
m1 &lt;- lm(birth_year ~ height + mass, data = starwars) %&gt;% 
  tidy(conf.int = TRUE) 

m1 %&gt;% 
  ggplot( aes(y = term, x = estimate) ) +
  geom_point() + 
  geom_errorbarh( aes(xmin = conf.low, xmax = conf.high) ) +
  geom_vline(xintercept = 0) # vertical line at 0
```

&lt;img src="Figs/tidy-coef-plot-1.png" style="display: block; margin: auto;" /&gt;


```r
"The p-value for `r m1$term[2]` is `r round( m1$p.value[2], 3)`."
```
"The p-value for height is 0.001."

---

### Omit the intercept


```r
m1 &lt;- lm(birth_year ~ height + mass, data = starwars) %&gt;% 
  tidy(conf.int = TRUE) 

m1 %&gt;%
  filter(term != "(Intercept)") %&gt;% 
  ggplot( aes(y = term, x = estimate) ) +
  geom_point() + 
  geom_errorbarh( aes(xmin = conf.low, xmax = conf.high)) +
  geom_vline(xintercept = 0) # vertical line at 0
```

&lt;img src="Figs/tidy-coef-terms-plot-1.png" style="display: block; margin: auto;" /&gt;


```r
"The p-value for `r m1$term[2]` is `r round( m1$p.value[2], 3)`."
```
"The p-value for height is 0.001."

---

### Pointrange


```r
m1 &lt;- lm(birth_year ~ height + mass, data = starwars) %&gt;% 
  tidy(conf.int = TRUE) 

m1 %&gt;% 
  filter(term != "(Intercept)") %&gt;% 
  ggplot( aes(x = term, y = estimate) ) +
  # geom_pointrange() is like geom_point() + geom_segment()
  geom_pointrange( aes(ymin = conf.low, ymax = conf.high) ) + 
  geom_hline(yintercept = 0) # horizontal line at 0
```

&lt;img src="Figs/tidy-pointrange-plot-1.png" style="display: block; margin: auto;" /&gt;


```r
"The p-value for `r m1$term[2]` is `r round( m1$p.value[2], 3)`."
```
"The p-value for height is 0.001."

---

### Pointrange + coord_flip()


```r
m1 &lt;- lm(birth_year ~ height + mass, data = starwars) %&gt;% 
  tidy(conf.int = TRUE) 

m1 %&gt;% 
  filter(term != "(Intercept)") %&gt;% 
  ggplot( aes(x = term, y = estimate) ) +
  # geom_pointrange() is like geom_point + geom_segment
  geom_pointrange( aes(ymin = conf.low, ymax = conf.high) ) + 
  geom_hline(yintercept = 0) + # "horizontal" line at 0
  coord_flip() # flip x and y axes
```

&lt;img src="Figs/tidy-pointrange-flip-1.png" style="display: block; margin: auto;" /&gt;


```r
"The p-value for `r m1$term[2]` is `r round( m1$p.value[2], 3)`."
```
"The p-value for height is 0.001."

---

## Always plot the data.

--


```r
starwars %&gt;% 
ggplot( aes(x = height, y = birth_year) ) + 
  geom_point( aes(size = mass) ) + 
  geom_label( aes(label = ifelse(birth_year &gt; 750, name, NA)), color = "red")
```

&lt;img src="Figs/point-1.png" style="display: block; margin: auto;" /&gt;

---

## Ideally, contrast data with claims.


```r
starwars %&gt;% 
  mutate(height_estimate = m1$estimate[1] + height*m1$estimate[2] )  %&gt;% 
ggplot( aes(x = height, y = birth_year) ) + 
  geom_point( aes(size = mass) ) +  
  geom_line( aes(y = height_estimate) ) + 
  geom_ribbon( aes( ymax = height_estimate + 1.96*sum(m1$std.error) ,
                    ymin = height_estimate - 1.96*sum(m1$std.error)),
               alpha =.2)
```

&lt;img src="Figs/lm-1.png" style="display: block; margin: auto;" /&gt;

*Note, for simplicity, I set mass equal to 0. What would be a better approach?

---

## `geom_smooth()` conditional mean


```r
starwars %&gt;% 
ggplot( aes(x = height, y = birth_year) ) + 
  geom_point( aes(size = mass) ) +  
  geom_smooth(formula =  "y ~ x", method = lm)
```

&lt;img src="Figs/smooth-1.png" style="display: block; margin: auto;" /&gt;

(quick &amp; dirty bivariate regression)

---

## !


```r
starwars %&gt;% filter(name != "Yoda") %&gt;% 
ggplot( aes(x = height, y = birth_year) ) + 
  geom_point( aes(size = mass) ) + 
  geom_smooth(formula =  "y ~ x", method = "lm")
```

&lt;img src="Figs/smooth-drop-outlier-1.png" style="display: block; margin: auto;" /&gt;

---

## !!


```r
starwars %&gt;% filter(!name %in% c("Yoda", "Jabba Desilijic Tiure") ) %&gt;% 
ggplot( aes(x = height, y = birth_year) ) + 
  geom_point( aes(size = mass) ) + 
  geom_smooth(formula =  "y ~ x", method = "lm")
```

&lt;img src="Figs/smooth-drop-outlier2-1.png" style="display: block; margin: auto;" /&gt;

---

## Regression fit by group


```r
starwars %&gt;%
  mutate(Human = species == "Human") %&gt;% 
ggplot( aes(x = height, y = birth_year) ) + 
  geom_point( aes(size = mass) ) + 
  geom_smooth(formula =  "y ~ x", method = "lm", aes(color = Human) )
```

&lt;img src="Figs/smooth-by-group-1.png" style="display: block; margin: auto;" /&gt;

---

![](Figs/curve_fitting.png)
---

# Truth, beauty, `ggplot()`

---

`aes`thetics map variables onto things people can see (position, color, etc.)

`geom`s are plot layers (points, lines, etc.)

`scale`s are how we show variation (negative = "red", thousands = value/1000, etc.)

`facet`s are mini-plots comparing subsets ("small multiples")


```r
starwars %&gt;% 
  unnest(films) %&gt;% 
  filter(films %in% c("Return of the Jedi", "The Force Awakens")) %&gt;% 
ggplot( aes(x = birth_year, y = height, color = species) ) + 
  geom_point( aes(size = mass), alpha = .5) + 
  geom_text(aes(label = name),  hjust = 0, vjust = 0, check_overlap = T) + 
  scale_x_continuous(limits = c(0, 1000) ) + 
  facet_wrap("films") + # facet by film
  labs(x = "Age", y = "Height", color = "Species", size = "Mass")
```

&lt;img src="Figs/starwars-height-1.png" style="display: block; margin: auto;" /&gt;

---
## Mapping


```r
world &lt;- map_data("world")

head(world)
```

```
##        long      lat group order region subregion
## 1 -69.89912 12.45200     1     1  Aruba      &lt;NA&gt;
## 2 -69.89571 12.42300     1     2  Aruba      &lt;NA&gt;
## 3 -69.94219 12.43853     1     3  Aruba      &lt;NA&gt;
## 4 -70.00415 12.50049     1     4  Aruba      &lt;NA&gt;
## 5 -70.06612 12.54697     1     5  Aruba      &lt;NA&gt;
## 6 -70.05088 12.59707     1     6  Aruba      &lt;NA&gt;
```

```r
world %&gt;% filter(region == "Aruba") %&gt;% 
ggplot( aes(x = long, y = lat, label = order) ) + geom_label()
```

&lt;img src="Figs/map-world-data-1.png" style="display: block; margin: auto;" /&gt;
---


```r
world %&gt;% 
ggplot( aes(x = long, y = lat) ) +  
  # A map layer of country shapes (geom_polygon connects the dots)
  geom_polygon( aes(group = group), fill = NA, color = "grey") +
  # We are here: 
  geom_point(aes(x=-89.4012, y=43.0731), color = "Red") 
```

&lt;img src="Figs/map-world-1.png" style="display: block; margin: auto;" /&gt;

---

```r
wi &lt;- map_data("county", "wisconsin")

wi %&gt;% 
  group_by(subregion) %&gt;%
ggplot( aes(x = long, y = lat, group = group) ) +
  geom_point() +
  geom_polygon(fill = NA, color = "grey60")
```

&lt;img src="Figs/map-wi-points-1.png" style="display: block; margin: auto;" /&gt;

---


```r
wi &lt;- map_data("county", "wisconsin")

wi %&gt;% 
  group_by(subregion) %&gt;%
  # Find the center of each subregion
  mutate(center_lat = mean(range(lat) ),
         center_long = mean(range(long) ) ) %&gt;%
ggplot( aes(x = long, y = lat, group = group) ) +
  geom_polygon(fill = NA, color = "grey60") +
  geom_text( aes(x = center_long, y = center_lat, label = subregion), size = 2, angle = 45, check_overlap = T)
```

&lt;img src="Figs/map-wi-1.png" style="display: block; margin: auto;" /&gt;

---
## `scale`

![](Figs/scales.png)

---
Using GIS data with `sf` (see [full example](https://github.com/judgelord/PS811/example_map_canada.Rmd), adapted [from Kieran Healy](https://kieranhealy.org/blog/archives/2018/12/09/canada-map/)).


```r
canada_cd &lt;- st_read("data/canada_cd_sim.geojson", quiet = TRUE) 

canada_cd %&gt;% 
ggplot() + 
  geom_sf(mapping = aes(fill = PRNAME)) 
```

&lt;img src="Figs/canada-1.png" style="display: block; margin: auto;" /&gt;

---
Change projection with `st_transform`: 


```r
canada_cd %&gt;% 
  # Lambert Conformal Conic projection
  st_transform(crs = "+proj=lcc +lat_1=49 +lat_2=77 +lon_0=-91.52 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs") %&gt;%
ggplot() + 
  geom_sf(mapping = aes(fill = PRNAME)) 
```

&lt;img src="Figs/canada- projection-1.png" style="display: block; margin: auto;" /&gt;

---

# Transformations
Summary stats with `stat`= \{`count`, `bin`, `density`, `smooth`, `ecdf`, `quantile`, etc.\}. `stat` applies some function to make a new variable (besides regression, nothing you could not have wrangled with `dplyr` `summary` or `mutate`).

---
## Distributions with `geom_histogram`


```r
lincoln_weather %&gt;% 
ggplot( aes(x = `Mean Temperature [F]`) ) +
  geom_histogram(binwidth = 10) + # i.e. geom_bar(stat = count, binwidth = 10)
  facet_grid(Month ~ .) + 
  theme(strip.text.y = element_text(angle = 0))
```

&lt;img src="Figs/hist-1.png" style="display: block; margin: auto;" /&gt;

---

## Distributions with `geom_density`


```r
lincoln_weather %&gt;% 
ggplot( aes(x = `Mean Temperature [F]`) ) +
  geom_density() +
  facet_grid(Month ~ .) + 
  theme(strip.text.y = element_text(angle = 0))
```

&lt;img src="Figs/density-1.png" style="display: block; margin: auto;" /&gt;

---

`ggridges`, lets us use a `y` scale instead of facets:


```r
library(ggridges)

lincoln_weather %&gt;% 
ggplot( aes(x = `Mean Temperature [F]`, y = Month, fill = ..x..) ) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis_c() +
  labs(title = "Temperatures in Lincoln NE in 2016", fill = "Temp. [F]")
```

&lt;img src="Figs/density-ggridges-1.png" style="display: block; margin: auto;" /&gt;

---
## Saving figures

*DO NOT save mouse-y style

![](Figs/save-wrong.png)

---

### `ggsave()` in .R

```r
ggplot(...) 
ggsave(here("Figs/figure-name.png"), width = 3, height = 3) # or .pdf etc.
```

### In .Rmd, figures save when you knit

```r
knitr::opts_chunk$set(here(fig.path="Figs/"),
                      fig.height = 3,
                      fig.width = 3)
```
### Chunk names = figure names!
    </textarea>
<style data-target="print-only">.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
